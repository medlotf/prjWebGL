<!DOCTYPE html>
<html>
	<head>
        <meta charset="utf-8">
        <title>Peojet WEBGL LOTF</title>
		<meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0" />
        <style>
            html, body { margin: 0; padding: 0; overflow: hidden; }
          </style>
		<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.css" />
	</head>
	<body>

        <script src="https://threejs.org/build/three.js"></script>
        <script src="js/GLTFLoader.js"></script>
        <script src="js/OrbitControls.js"></script>
        <script>  


            let scene,camera,renderer,controls,right, up, at;
            let keyboard={};
            let player={pHeight:300,speed:20,turnSpeed:Math.PI*0.02};
            let rotation = 0;
            let directions = {};
            directions.forward = false;
            directions.backward = false;
            directions.left = false;
            directions.right = false;
            let gun;

            let init=()=>{

                //Scene:
                scene= new THREE.Scene();
                scene.background=new THREE.Color(0xdddddd);

                //Vector pour le rÃ©glages de la direc
                right = new THREE.Vector3();
                up = new THREE.Vector3();
                at = new THREE.Vector3();

                //Camera:
                camera= new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,45,30000);
                camera.position.set(238,300,3160);
                camera.matrix.extractBasis(right,up,at);
                
                
                //Renderer:
                renderer=new THREE.WebGLRenderer({antialias:true});
                renderer.setSize(window.innerWidth,window.innerHeight);
                document.body.appendChild(renderer.domElement);

                //Controls:
            /*  controls = new THREE.OrbitControls(camera,renderer.domElement);
                controls.addEventListener('change', renderer);
                controls.minDistance=100;
                controls.maxDistance=30000;*/

                //Skybox:
                let materialArray=[];
                let loader=new THREE.TextureLoader();
                let txt_ft=loader.load('Skybox/meadow_ft.jpg');
                let txt_bk=loader.load('Skybox/meadow_bk.jpg');
                let txt_up=loader.load('Skybox/meadow_up.jpg');
                let txt_dn=loader.load('Skybox/meadow_dn.jpg');
                let txt_rt=loader.load('Skybox/meadow_rt.jpg');
                let txt_lf=loader.load('Skybox/meadow_lf.jpg');
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_ft, side:THREE.DoubleSide}));
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_bk, side:THREE.DoubleSide}));
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_up, side:THREE.DoubleSide}));
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_dn, side:THREE.DoubleSide}));
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_rt, side:THREE.DoubleSide}));
                materialArray.push(new THREE.MeshBasicMaterial({map:txt_lf, side:THREE.DoubleSide}));
                let skyboxGeo= new THREE.BoxGeometry(20000,20000,20000);
                let skybox=new THREE.Mesh(skyboxGeo,materialArray);
                scene.add(skybox);

                var lightt = new THREE.AmbientLight( 0x404040 ); // soft white light
                scene.add( lightt );
                //PointLight
                let light = new THREE.PointLight(0xc4c4c4,0.1);
                light.position.set(0,300,500);
                scene.add(light);
                let light2 = new THREE.PointLight(0xc4c4c4,0.1);
                light2.position.set(500,100,0);
                scene.add(light2);
                let light3 = new THREE.PointLight(0xc4c4c4,0.1);
                light3.position.set(0,100,-500);
                scene.add(light3);
                let light4 = new THREE.PointLight(0xc4c4c4,0.1);
                light4.position.set(-500,300,500);
                scene.add(light4);
    
                //House1 object
                let loaderGLTF=new THREE.GLTFLoader();
                loaderGLTF.load('fbx/house1/scene.gltf',(obj)=>{
                    let car=obj.scene.children[0];
                    car.scale.set(300,300,300);
                    car.position.set(0,270,0);
                    scene.add(obj.scene);
                });
                
                loaderGLTF.load('fbx/ARX-160/scene.gltf',(obj)=>{
                    let car=obj.scene.children[0];
                    car.scale.set(1,1,1);
                    car.position.set(238,300,2360);
                    gun=obj.scene;
                    scene.add(gun);
                });

                //Plane:
                let planeGeo=new THREE.PlaneGeometry(15000,15000);
                let planeTexture=new THREE.TextureLoader().load('texture/grass.png');
                let planeMat=new THREE.MeshBasicMaterial({map: planeTexture,side: THREE.DoubleSide,needsUpdate: true});
                let plane=new THREE.Mesh(planeGeo,planeMat);
                plane.rotation.x = -Math.PI / 2;
                scene.add(plane);
                

                window.addEventListener("keydown", onKeyDown, false);
                window.addEventListener("keyup", onKeyUp, false);
                window.addEventListener("mousemove", onMouseMove, false);

                animate();
            }

            let animate=()=>{
                requestAnimationFrame(animate);
                camera.rotation.y += rotation;
                camera.matrix.extractBasis(right,up,at);
                if(directions.forward) {
                    camera.position.add(at.multiplyScalar(-50));
                    camera.matrix.extractBasis(right,up,at);
                    console.log(camera.position);
                }
                if(directions.backward) {
                    camera.position.add(at.multiplyScalar(50));
                    camera.matrix.extractBasis(right,up,at);
                }
                if(directions.left) {
                    camera.position.add(right.multiplyScalar(-50));
                    camera.matrix.extractBasis(right,up,at);
                }
                if(directions.right) {
                    camera.position.add(right.multiplyScalar(50));
                    camera.matrix.extractBasis(right,up,at);
                }
                //gun.visible=false;
                renderer.render( scene, camera );
            }
                        
            function onKeyDown(e) {
                switch(e.keyCode) {
                    case 81: // Q
                        directions.left = true;break;
                    case 90: // Z
                        directions.forward = true;break;
                    case 68: // D
                        directions.right = true;break;
                    case 83: // S
                        directions.backward = true;break;
                }
            }
            
            function onKeyUp(e) {
                switch(e.keyCode) {
                    case 81: // Q
                        directions.left = false;break;
                    case 90: // Z
                        directions.forward = false;break;
                    case 68: // D
                        directions.right = false;break;
                    case 83: // S
                        directions.backward = false;break;
                }
            }
            
            function onMouseMove(event) {
                var frRotation = {};
                frRotation.minX = Math.abs(window.innerWidth - 300) / 2;
                frRotation.maxX = frRotation.minX + 300;
                
                if(event.clientX < frRotation.minX) {
                    rotation = Math.min(0.1, 0.00005 * (frRotation.minX - event.clientX));
                }
                else if(event.clientX > frRotation.maxX) {
                    rotation = Math.max(-0.1, -0.00005 * (event.clientX - frRotation.maxX));
                }
                else {
                    rotation = 0;
                }
            }

            window.onload=init;
        </script>
	</body>
</html>